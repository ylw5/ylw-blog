运行 sudo nginx 开启反向代理，可通过主要配置分析：

> 反向代理：代理服务器，客户端不知道真正返回数据的服务端是谁

```
server 
{
  // ...
	listen 80; // 监听 80 端口
  // 监听 URL 地址，前者是线下地址，后者是线上地址
	server_name ~local\.page\.banma\.(?<env>.+)\.sankuai\.com local\.page\.peisong\.meituan\.com; 
  // 开启 SSI 功能
  ssi on;
  // 配置反向代理 /api 请求
  location /api
  {
    // 当请求的 Host 头部（服务器域名）匹配 local.page.banma 时，将该请求反向代理到 http://page.banma.$env.sankuai.com 这个服务器上
    // env 根据环境动态选择代理目标服务器
    if ($host ~ "local\.page\.banma"){
      proxy_pass http://page.banma.$env.sankuai.com;
    }
  }
  // 本地开发环境下，把 /dist/page 路径真实请求代理到webpack热启动缓存（后文会讲到）
  location /dist/page/
  {
    proxy_pass http://localhost:8080;
  }
  // ...
  // 重写 URI 地址实现重定向、请求合并
  rewrite ^/([0-9A-Za-z]+)/([0-9A-Za-z]+)$ /page/$1/$2.shtml last;
  rewrite ^/([0-9A-Za-z]+)/([0-9A-Za-z]+)/([0-9A-Za-z]+)$ /page/$1/$2-$3.shtml last;
  rewrite ^/([0-9A-Za-z]+)/([0-9A-Za-z]+)/([0-9A-Za-z]+)/([0-9A-Za-z]+)$ /page/$1/$2-$3-$4.shtml last;
  // 指定服务器的根目录
  root /Users/ylw/banma_page
  // ...
}
```

当在终端输入 npm run start 时会执行 webpack-dev-server --config webpack.config.js，将所有当页面入口文件打包，放到 dist 目录下；并且本地开启一个开发服务器监听 8080 端口，存放 dist 目录下的文件。在 webpack.config.js配置文件中可以找到以下配置：

```
devServer: {
  port: 8080,
  stats: {
    errors: true,
    warnings: true
  },
  contentBase: path.join(__dirname, 'dist')
},
```

以指定 dir=customerManage 为例，如图，此时可通过访问 localhost:8080 获取打包后的所有文件。

![[banama_page_8080.png]]

然后在 URL 中输入 [http://pagelocal.banma.test.sankuai.com/customerManage/customer/list](http://pagelocal.banma.test.sankuai.com/customerManage/customer/list)并访问，客户端发送请求。通常 http 请求使用的端口号是 80，此时 nginx 正在监听该端口，根据以下配置：

```
// 监听 URL 地址，前者是线下地址，后者是线上地址
server_name ~local\.page\.banma\.(?<env>.+)\.sankuai\.com local\.page\.peisong\.meituan\.com; 
```

URL 匹配，nginx 服务器成功匹配到了该地址，并且根据配置：

```
rewrite ^/([0-9A-Za-z]+)/([0-9A-Za-z]+)/([0-9A-Za-z]+)$ /page/$1/$2-$3.shtml last;
```

nginx 服务器会将该 URL 重定向到 /page/customerManage/customer-list.shtml，可在项目目录（根据 nginx 服务器配置的 root 根目录）中找到 ${root}/page/customerManage-list.shtml 该文件。该文件内容如下所示：

```html
<!DOCTYPE HTML>
<html>

<head>
    <title>客户列表 - 客户管理</title>
    <!-- 各自页面使用的css文件，需放置在header.htm之前 -->
    <!-- #include file="/page/inc/header.htm" -->
    <!-- 开发页面部分start -->
    <link rel="stylesheet" type="text/css" href="/static/lib/tangram-ui/1.0.49/tangram-ui.min.css">
    <div id="App"></div>

    <!-- 开发页面部分end -->
    <script type=" text/javascript " src="/dist/page/customerManage/customer-list-entry.pack.js"></script>

    <!--#include file="/page/inc/footer.htm"-->
```

由于 nginx 开启了 SSI 功能，服务器会先解析 shtml 文件，引入项目通用代码（文件位置在 page/inc 目录下），拼接为完整 html 后然后返回浏览器。

html 解析到 script 标签引入了打包后的页面入口 js 文件，发送网络请求，路径是为 /dist/page/*/*.pack.js 。命中 nginx 的代理配置：

```
// 本地开发环境下，把 /dist/page 路径真实请求代理到webpack热启动缓存
location /dist/page/
{
  proxy_pass http://localhost:8080;
}
```

这时 nginx 会把该请求转发到 http://localhost:8080。由于 webpack 在 8080 端口开启了开发服务器，存放 dist 目录下的文件（页面入口 js 文件）。于是 webpack 开发服务器将这部分文件内容返回。

> 由于在开发过程中，页面代码是经常修改的，所以为了提升开发体验和效率，通过 webpack 开发服务器获得热更新能力。

浏览器获得页面入口文件后，执行 js，渲染页面，执行业务逻辑。